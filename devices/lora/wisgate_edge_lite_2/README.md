# WISGATE_EDGE_LITE_2

## Device

- Product: RAK WisGate Edge Lite 2 V2
- Role in this PoC: LoRaWAN gateway used with ChirpStack through LoRa Basics Station
- Main validation target: runbook step `F1` (server-side Basics Station LNS + TLS readiness)

## Goal of this guide

Prepare and validate the server-side LNS endpoint (`wss`) that the gateway will use, before gateway UI configuration (`F2`).

## Sources

- Runbook: `poc_project_runbook_ubuntu_EN.md` (`F1`, `F2`, `F3`)
- Gateway Bridge template: `stack/templates/chirpstack-gateway-bridge.toml.tmpl`
- TLS generation script: `scripts/30_generate_tls_basics_station.sh`
- Config render script: `scripts/15_render_configs.sh`
- RAK7268 WisGate Edge Lite 2 quickstart:
  `https://docs.rakwireless.com/product-categories/wisgate/rak7268/quickstart`
- Arduino WisGate Edge Lite 2 page:
  `https://docs.arduino.cc/hardware/wisgate-edge-lite-2/`

## Prerequisites

- Stack is up and healthy
- `stack/.env` exists
- You know the host that the gateway can reach for LNS (DNS name or fixed LAN IP)

----------------------------------------------

## Step-by-step for F1 (server side)

### 1) Set LNS host and port in `.env`

Update these values in `stack/.env`:

- `LNS_HOST`: host used by the gateway in its URI (must match TLS certificate SAN)
- `LNS_PORT`: LoRa Basics Station port (default: `3443`)

Example target URI that will later be configured in gateway UI:

- `wss://<LNS_HOST>:<LNS_PORT>`

### 2) Generate TLS assets for Basics Station

```bash
cd ~/Public/poc
bash scripts/30_generate_tls_basics_station.sh
```

Expected output files:

- `stack/gateway-bridge/certs/ca.crt`
- `stack/gateway-bridge/certs/server.crt`
- `stack/gateway-bridge/certs/server.key`

Certificate profile generated by the script:

- CA cert with `CA:TRUE`
- Server cert with SAN matching `LNS_HOST`, `Key Usage` and `Extended Key Usage: TLS Web Server Authentication`

### 3) Render Gateway Bridge config from `.env`

```bash
cd ~/Public/poc
bash scripts/15_render_configs.sh
```

Quick checks:

```bash
rg -n "type=\"basic_station\"|bind=|ca_cert=|tls_cert=|tls_key=" ~/Public/poc/stack/gateway-bridge/chirpstack-gateway-bridge.toml
```

Expected values in rendered config:

- `type="basic_station"`
- `bind="0.0.0.0:<LNS_PORT>"`
- TLS cert/key paths under `/etc/chirpstack-gateway-bridge/certs/`

### 4) Restart only Gateway Bridge

```bash
cd ~/Public/poc/stack
docker compose up -d chirpstack-gateway-bridge
docker compose ps chirpstack-gateway-bridge
```

### 5) Validate runtime and TLS

Capture logs:

```bash
docker logs --tail 200 chirpstack-gateway-bridge \
  | tee ~/Public/poc/evidence/logs/F1_gwbridge_logs.txt
```

Validate TLS handshake from host:

```bash
source ~/Public/poc/stack/.env
openssl s_client -connect localhost:${LNS_PORT} -servername "${LNS_HOST}" \
  -CAfile ~/Public/poc/stack/gateway-bridge/certs/ca.crt < /dev/null \
  | tee ~/Public/poc/evidence/logs/F1_gwbridge_tls_check.txt
```

Validation points:

- No repeated TLS errors in Gateway Bridge logs
- `Verify return code: 0 (ok)` appears in TLS check output
- Server cert exposes `Extended Key Usage: TLS Web Server Authentication`:

```bash
openssl x509 -in ~/Public/poc/stack/gateway-bridge/certs/server.crt -noout -text \
  | rg -n "Extended Key Usage|Key Usage|Subject Alternative Name"
```

### 6) Export config evidence for F1

```bash
cp ~/Public/poc/stack/gateway-bridge/chirpstack-gateway-bridge.toml \
  ~/Public/poc/evidence/configs/F1_chirpstack_gateway_bridge.toml
cp ~/Public/poc/stack/gateway-bridge/certs/ca.crt \
  ~/Public/poc/evidence/configs/F1_lns_ca.crt
```

## F1 pass criteria

- Gateway Bridge starts with Basics Station backend and TLS files loaded
- TLS handshake check succeeds with the generated CA
- Evidence files exist:
  - `evidence/logs/F1_gwbridge_logs.txt`
  - `evidence/logs/F1_gwbridge_tls_check.txt`
  - `evidence/configs/F1_chirpstack_gateway_bridge.toml`
  - `evidence/configs/F1_lns_ca.crt`

## Troubleshooting

- `read ca cert error ... permission denied` or `open ... server.key: permission denied`:
  - re-run `bash scripts/30_generate_tls_basics_station.sh` (it applies container-compatible cert permissions)
  - run `docker compose -f stack/docker-compose.yml up -d --force-recreate chirpstack-gateway-bridge`
  - re-check logs with `docker logs --tail 200 chirpstack-gateway-bridge`
- `tls: client didn't provide a certificate`:
  - one occurrence can be normal during manual `openssl s_client` checks
  - if it repeats continuously when the gateway tries to connect, verify gateway TLS/auth settings in F2

----------------------------------------------

## Step-by-step for F2 (gateway UI side)

### 1) Collect the exact server values to apply in gateway UI

```bash
source ~/Public/poc/stack/.env
printf 'LNS URI: wss://%s:%s\n' "$LNS_HOST" "$LNS_PORT"
printf 'CA file: %s\n' "$HOME/Public/poc/stack/gateway-bridge/certs/ca.crt"
```

Use exactly:

- LNS URI: `wss://<LNS_HOST>:<LNS_PORT>`
- CA file: `stack/gateway-bridge/certs/ca.crt`
- Current discovered PC (LNS host) IP for this PoC run: `172.17.0.85`
- Current direct URI for this run: `wss://172.17.0.85:3443`

### 2) Open WisGate Edge Lite 2 web UI

- Connect to the same LAN as the gateway
- Open gateway management IP in browser (`http://<gateway_ip>` or `https://<gateway_ip>`)
- Log in with admin credentials
- Current discovered gateway IP for this PoC run: `172.17.0.22` (`https://172.17.0.22`)

#### Gateway IP discovery

If gateway IP is unknown, use one of these methods:

- Check router DHCP leases
- Or discover your real LAN subnet first, then scan:

```bash
ip -4 route
# Example LAN subnet found on this host: 172.17.0.0/24
nmap -sn 172.17.0.0/24
arp -a
```

Important:

- Do not assume `192.168.1.0/24`; scan the subnet shown by `ip -4 route`.

Then identify the gateway by:

- Hostname/vendor string (`RAK`, `WisGate`) or HTTPS management page response
- Gateway MAC address label from hardware sticker / vendor UI

#### Should the gateway IP be fixed?

Yes, recommended for this PoC.

- Best option: configure DHCP reservation on your router (`gateway MAC -> fixed IP`)
- Alternative: static IP in gateway network settings
- Record the fixed IP in your evidence notes for reproducibility

### 3) Set regional radio parameters (EU868)

In the LoRa settings page:

- Region / Frequency plan: `EU868`
- Confirm channel-plan matches your runbook target
- Save changes

### 4) Switch gateway protocol to Basics Station

In packet forwarder / network server settings:

- Enable `Basics Station`
- Disable other forwarders if enabled (for example legacy UDP packet-forwarder)
- Save changes

### 5) Configure LNS-only mode

In Basics Station server settings:

- LNS Server / URI: `wss://<LNS_HOST>:<LNS_PORT>`
- For this PoC run (direct IP): `wss://172.17.0.85:3443`
- CUPS Server: empty / disabled
- Authentication mode: `TLS Server Authentication`
- Do not select `TLS server & Client Authentication` or token authentication modes for this PoC setup
- Import / upload CA certificate: `stack/gateway-bridge/certs/ca.crt`
- Apply settings and reboot gateway if UI requests it

### 6) Validate gateway-to-LNS connectivity

After saving gateway settings, check server-side logs:

```bash
docker logs --tail 200 -f chirpstack-gateway-bridge \
  | tee ~/Public/poc/evidence/logs/F2_gwbridge_gateway_connect.txt
```

Expected:

- No repeated TLS handshake failures
- Gateway starts connecting (connection attempts visible in logs)

### 7) Record F2 evidence

Capture screenshots from gateway UI:

- EU868 region/channel-plan page
- Basics Station mode enabled
- LNS URI and CUPS disabled/empty
- CA import/trust page
- Connection/online status page

Optional server evidence copy:

```bash
cp ~/Public/poc/stack/gateway-bridge/certs/ca.crt \
  ~/Public/poc/evidence/configs/F2_lns_ca_used_by_gateway.crt
```

## F2 pass criteria

- Gateway is configured in Basics Station mode
- Gateway points to correct `wss://<LNS_HOST>:<LNS_PORT>`
- CA trust is configured on the gateway
- Gateway shows connected, and Gateway Bridge logs show stable connectivity

----------------------------------------------

## Step-by-step for F3 (register gateway in ChirpStack and prove online)

### 1) Get the exact Gateway EUI from WisGate UI

From the gateway web UI status/device page, copy the Gateway EUI exactly.

Expected format:

- 16 hex characters (example: `AC1F09FFFE141E03`)

Important:

- Use the exact EUI shown by the gateway
- Do not replace it with MAC address unless vendor UI explicitly says they are the same identifier

### 2) Add gateway in ChirpStack UI

- Open `http://localhost:8080`
(admin/admin for now, bad, bad)
- Go to your Tenant, then `Gateways`, then `Add gateway`
- Fill:
  - Name: `wisgate_edge_lite_2`
  - Gateway ID: `<GATEWAY_EUI>` (ac1f09fffe141e03)
  - Network-server / tenant fields: keep default for your current tenant
- Save

### 3) Validate first online status

In ChirpStack gateway details page:

- Confirm gateway appears as `online`
- Confirm `Last seen` updates

If UI still shows `Never seen`, verify backend value directly:

```bash
docker exec postgres psql -U chirpstack -d chirpstack -c \
"select encode(gateway_id,'hex') as gateway_id,name,last_seen_at, now()-last_seen_at as age from chirpstack.gateway;"
```

Expected:

- `gateway_id` matches your configured Gateway ID
- `last_seen_at` is recent (age in seconds, not hours)

Take a screenshot and save it to evidence:

- `evidence/pictures/F3_gateway_online_before_reboot.png`

### 4) Start reconnect evidence capture

Run this before rebooting the gateway:

```bash
echo "reboot_test_start_utc=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
  | tee ~/Public/poc/evidence/logs/F3_reboot_window.txt
docker logs --tail 200 -f chirpstack-gateway-bridge \
  | tee ~/Public/poc/evidence/logs/F3_gwbridge_reconnect.txt
```

### 5) Reboot gateway and measure reconnection

- Reboot from WisGate UI (or power-cycle once if UI reboot is unavailable)
- Wait until gateway returns online in ChirpStack
- Record reconnect timestamp:

```bash
echo "reconnected_utc=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
  | tee -a ~/Public/poc/evidence/logs/F3_reboot_window.txt
```

Take screenshot after reconnect:

- `evidence/pictures/F3_gateway_online_after_reboot.png`

### 6) Compute reconnection duration (seconds)

```bash
awk -F= '
  /reboot_test_start_utc/ {start=$2}
  /reconnected_utc/ {end=$2}
  END {
    cmd_start="date -u -d \"" start "\" +%s"; cmd_start | getline s; close(cmd_start);
    cmd_end="date -u -d \"" end "\" +%s"; cmd_end | getline e; close(cmd_end);
    if (s>0 && e>0) {
      print "reconnect_duration_s=" (e-s);
    } else {
      print "reconnect_duration_s=NA";
    }
  }
' ~/Public/poc/evidence/logs/F3_reboot_window.txt \
  | tee ~/Public/poc/evidence/logs/F3_reconnect_duration.txt
```

## F3 pass criteria

- Gateway is registered in ChirpStack with the exact Gateway EUI
- Gateway shows online with updated `Last seen`
- After one reboot, gateway reconnects within your documented window
- Evidence exists:
  - `evidence/logs/F3_gwbridge_reconnect.txt`
  - `evidence/logs/F3_reboot_window.txt`
  - `evidence/logs/F3_reconnect_duration.txt`
  - `evidence/pictures/F3_gateway_online_before_reboot.png`
  - `evidence/pictures/F3_gateway_online_after_reboot.png`
