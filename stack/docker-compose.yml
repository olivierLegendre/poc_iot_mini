name: poc-iot

services:
  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: mosquitto
    restart: unless-stopped
    ports:
      - "1883:1883"
    volumes:
     # Mount config directory as RW because the image may chown config files on startup.
      - ./mosquitto:/mosquitto/config
      - mosquitto-data:/mosquitto/data
      - mosquitto-log:/mosquitto/log
    environment:
      - TZ=${TZ}
    healthcheck:
      test: ["CMD-SHELL", "pidof mosquitto > /dev/null"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  postgres:
    image: postgres:16
    container_name: postgres
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_PASSWORD=${PG_PASSWORD}
      - TZ=${TZ}
    volumes:
      - pg-data:/var/lib/postgresql/data
      - ./postgres/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  redis:
    image: redis:7
    container_name: redis
    restart: unless-stopped
    environment:
      - TZ=${TZ}
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  chirpstack:
    image: chirpstack/chirpstack:4
    container_name: chirpstack
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      mosquitto:
        condition: service_healthy
    ports:
      - "8080:8080"
    env_file:
      - .env
    volumes:
      # ChirpStack v4 must be started with --config-dir pointing to a directory of .toml files.
      - ./chirpstack:/etc/chirpstack:ro
    command: ["--config", "/etc/chirpstack"]
    environment:
      - TZ=${TZ}

  chirpstack-gateway-bridge:
    image: chirpstack/chirpstack-gateway-bridge:4
    container_name: chirpstack-gateway-bridge
    restart: unless-stopped
    depends_on:
      mosquitto:
        condition: service_healthy
    ports:
    # LoRa Basics Station LNS (ws/wss)
      - "${LNS_PORT}:${LNS_PORT}"
    env_file:
      - .env
    volumes:
      - ./gateway-bridge/chirpstack-gateway-bridge.toml:/etc/chirpstack-gateway-bridge/chirpstack-gateway-bridge.toml:ro
      - ./gateway-bridge/certs:/etc/chirpstack-gateway-bridge/certs:ro
    environment:
      - MQTT_SERVER=tcp://${MQTT_HOST}:${MQTT_PORT}
      - TZ=${TZ}

  zigbee2mqtt:
    image: koenkk/zigbee2mqtt:${ZIGBEE2MQTT_TAG:-1.40.2}
    container_name: zigbee2mqtt
    profiles:
      - zigbee
    restart: "on-failure:5"
    depends_on:
      mosquitto:
        condition: service_healthy
      zigbee-adapter-sim:
        condition: service_healthy
    ports:
      - "8081:8080"
    env_file:
      - .env
    volumes:
    # Must be writable (Z2M updates configuration.yaml via UI).
      - ./zigbee2mqtt:/app/data
    environment:
      - TZ=${TZ}

  nodered:
    build:
      context: ./nodered
    container_name: nodered
    restart: unless-stopped
    depends_on:
      mosquitto:
        condition: service_healthy
      postgres:
        condition: service_healthy
    ports:
      - "1880:1880"
    env_file:
      - .env
    environment:
      - TZ=${TZ}
    volumes:
      - nodered-data:/data

  zigbee-adapter-sim:
    image: alpine:3.18
    container_name: zigbee-adapter-sim
    restart: unless-stopped
    profiles:
      - zigbee
    # Simple TCP listener to simulate a serial-over-TCP adapter for Zigbee2MQTT
    command: sh -c "while true; do nc -l -p 6638 >/dev/null 2>&1; done"
    # expose port internally (optional mapping to host can be added)
    ports:
      - "6638"
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 6638"]
      interval: 10s
      timeout: 3s
      retries: 5

volumes:
  pg-data:
  mosquitto-data:
  mosquitto-log:
  nodered-data:
